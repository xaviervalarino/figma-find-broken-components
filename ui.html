<div style="font-family: sans-serif">
  <div
    style="
      display: flex;
      padding: 8px;
      justify-content: space-between;
      align-items: center;
    "
  >
    <h4 style="margin: 0">Found on Current Page</h4>
  </div>
  <div id="loading" style="display: block">Loading...</div>
  <div id="list" style="padding-left: 0; list-style-type: none"></div>
</div>

<script>
  const list = document.getElementById("list");
  const loading = document.getElementById("loading");

  onmessage = (event) => {
    const { type, found } = event.data.pluginMessage;

    if (type === "user-action") {
      loading.style.display = "block";
    }
    if (type === "selectionchange") {
      for (const li of list.querySelectorAll("li")) {
        li.style.background = "";
      }
    }

    if (type === "found") {
      setTimeout(() => {
        loading.style.display = "none";
      }, 300);

      const listOfComponents = [];

      for (const [mainComponent, instances] of Object.entries(found)) {
        const componentList = document.createElement("details");
        const summary = document.createElement("summary");
        const summaryContent = document.createElement('div')
        const span = document.createElement("span");
        const ul = document.createElement("ul");

        const listItems = instances.map(({ id, txt }) => {
          const li = document.createElement("li");
          const div = document.createElement("div");
          const button = document.createElement("button");

          li.style = "padding: 8px; border-top: 1px solid rgba(10,10,10,0.1)";
          button.textContent = "Go to";
          button.onclick = () => {
            parent.postMessage(
              { pluginMessage: { type: "go-to-broken", id: id } },
              "*"
            );
            // super janky---this is so that the focus event doesn't undo this
            setTimeout(() => {
              li.style.background = "lightblue";
            }, 200);
          };
          div.textContent = txt;
          div.style = "display: flex; justify-content: space-between";
          div.appendChild(button);
          li.appendChild(div);
          return li;
        });
        summaryContent.style =
          "display: flex; justify-content: space-between; padding: 8px 2px";
        span.style =
          "background: salmon; padding: 2px 8px; border-radius: 50px;";
        ul.replaceChildren(...listItems);
        summaryContent.textContent = mainComponent;
        span.textContent = instances.length;
        summaryContent.appendChild(span);
        summary.appendChild(summaryContent)
        componentList.replaceChildren(summary, ul);
        listOfComponents.push(componentList);
      }

      if (!listOfComponents.length)
        listOfComponents.push("ðŸŽ‰ No broken components");
      list.replaceChildren(...listOfComponents);
    }
  };
</script>
